<html>
<head>
    <style type="text/css">
        html, body {
            margin: 0;
            padding: 0;
            font-family: sans-serif;
            overflow: hidden;
        }
        #wrapper {
            width: 100vw;
            display: flex;
            flex-direction: row;
            border-bottom: 1px solid black;
        }
        #logs {
            width: 100vw;
            height: 47vh;
            display: flex;
            flex-direction: row;
        }
        .side {
            width: 50vw;
        }
        .side .side-headline {
            display: block;
            padding: 3px;
            font-weight: bold;
            color: white;
        }
        #code {
            width: 100%;
            height: 50%;
        }
        #wrapper .side .success {
            background-color: green;
        }
        #wrapper .side .fail {
            background-color: red;
        }
        #mocha {
            display: none;
        }
        #mochaFrame {
            margin: 0;
            padding: 0;
            border: 0;
            width: 100%;
            height: 100%;
        }
        #console {
            font-size: smaller;
            margin: 0;
            overflow: scroll;
            height: 100%;
        }
    </style>
</head>
<body>
    <div id="wrapper">
        <div class="side">
            <label class="side-headline" for="code">Code</label>
            <div id="code"></div>
        </div>
        <div class="side">
            <label class="side-headline" for="playground">Canvas</label>
            <div id="playground"></div>
        </div>
    </div>
    <div id="logs">
        <div class="side">
            <div id="mocha"></div>
            <iframe id="mochaFrame"></iframe>
        </div>
        <div class="side">
            <pre id="console"></pre>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mocha/3.2.0/mocha.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chai/3.5.0/chai.js"></script>
    <script src="node_modules/monaco-editor/min/vs/loader.js"></script>
    <script type="text/javascript">
        const htmlLog = document.getElementById('console');
        const originalLog = console.log;
        console.log = function(...args) {
            htmlLog.innerHTML = htmlLog.innerHTML + args.join(' ') + '\n';
            originalLog.apply(originalLog, args);
        }

        const getUrlParams = function getUrlParams(query) {
            return query.substring(1).split('&').reduce((akku, part) => { const parts = part.split('='); akku[parts[0]] = decodeURIComponent(parts[1]); return akku; }, {});
        }

        const createUrl = function createUrl(opts) {
            return `${location.pathname}?code=${encodeURIComponent(opts.code || '')}&grep=${encodeURIComponent(opts.grep || '')}`;
        }

        this.expect = chai.expect;
        mocha.setup('bdd');
        const mochaContainer = document.getElementById('mocha');

        const save = function save(code) {
            const url = createUrl({
                code,
                grep: getUrlParams(location.search).grep
            })
            history.replaceState(undefined, undefined, url);
        }

        const updateIndicator = function updateIndicator(failures) {
            const indicatorLabels = document.querySelectorAll('.side .side-headline');
            if (failures === 0) {
                indicatorLabels.forEach(label => {
                    label.classList.remove('fail');
                    label.classList.add('success');
                });
            } else {
                indicatorLabels.forEach(label => {
                    label.classList.remove('success');
                    label.classList.add('fail');
                });
            }
        }

        const mochaFrame = document.getElementById('mochaFrame');
        (function setupFrame() {
            mochaFrame.contentWindow.document.head.innerHTML =
                '<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mocha/3.2.0/mocha.min.css">';
            mochaFrame.contentWindow.document.body.innerHTML = '<div id="mocha"></div>';
            mochaFrame.contentWindow.document.addEventListener('click', e => {
                e.preventDefault();
                if (e.target.tagName === 'A') {
                    const a = document.createElement('a');
                    a.href = e.target.href;
                    console.log(a.search);
                    const mochaParams = getUrlParams(a.search);
                    const url = createUrl({
                        code: getUrlParams(location.search).code,
                        grep: mochaParams.grep
                    });
                    location.href = url;
                }
            });
        })();
        const updateFrame = function updateFrame() {
            mochaFrame.contentWindow.mocha.innerHTML = mochaContainer.innerHTML;
        }

        let last = undefined;
        const run = function run(current) {
            if (current != last) {
                last = current;
                mocha.suite.suites = [];
                mochaContainer.innerHTML = '';
                try {
                    eval(current);
                    mocha.checkLeaks();
                    const results = mocha.run();
                    setTimeout(() => {
                        updateIndicator(results.failures);
                        updateFrame();
                    }, 0);
                } catch (e) {
                    updateIndicator(1);
                    updateFrame();
                    mochaContainer.innerHTML = `<pre>${e.stack}</pre>`;
                }
            }
        }

        require.config({ paths: { 'vs': 'node_modules/monaco-editor/min/vs' }});
        require(['vs/editor/editor.main'], function() {
            monaco.languages.typescript.javascriptDefaults.setCompilerOptions({
                target: monaco.languages.typescript.ScriptTarget.Latest,
                allowNonTsExtensions: true
            });
            // add mocha.d.ts
            fetch('node_modules/@types/mocha/index.d.ts')
                .then(response => response.text())
                .then(text => {
                    monaco.languages.typescript.javascriptDefaults.addExtraLib(text, 'mocha.d.ts');
                });
            // add chai.d.ts
            fetch('node_modules/@types/chai/index.d.ts')
                .then(response => response.text())
                .then(text => {
                    monaco.languages.typescript.javascriptDefaults.addExtraLib(text, 'chai.d.ts');
                });
            monaco.languages.typescript.javascriptDefaults.addExtraLib('declare var expect: typeof chai.expect;', 'chai-global.d.ts');

            const editor = monaco.editor.create(document.getElementById('code'), {
                value: getUrlParams(location.search).code || `
// document.getElementById('playground') will return the right side div
const add = (a, b) => a + b;

describe('add',() => {
  it('should return the sum of 1 and 2', () => {
    expect(add(1, 2)).to.equal(2);
  });
});
`,
                language: 'javascript'
            });
            // Save shortcut
            editor.addAction({
                id: 'save',
                label: 'Save',
                keybindings: [monaco.KeyMod.CtrlCmd | monaco.KeyCode.KEY_S],
                keybindingContext: null,
                run: function(ed) {
                    save(ed.getModel().getValue());
                    return null;
                }
            });
            editor.focus();
            run(editor.getModel().getValue());

            editor.getModel().onDidChangeContent(() => {
                const code = editor.getModel().getValue();
                save(code);
                run(code);
            });
        });
    </script>
</body>
</html>
